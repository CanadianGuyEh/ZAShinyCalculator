<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shiny Hunt Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #4a5568;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --accent-primary: #38b2ac;
            --accent-secondary: #319795;
            --accent-disabled: #4a5568;
            --error-primary: #e53e3e;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .toggle-btn-active {
            background-color: var(--accent-primary);
            color: var(--bg-primary);
            font-weight: 600;
        }
        .toggle-btn-inactive {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        .toggle-hidden {
            display: none;
        }
        .form-input, .form-select {
            background-color: var(--bg-secondary);
            border: 1px solid var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-secondary);
        }
        .form-input:disabled, .form-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .form-input.read-only-display {
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            font-weight: 500;
            cursor: default;
        }
        .form-checkbox:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: var(--accent-primary);
            color: var(--bg-primary);
            font-weight: 600;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--accent-secondary);
        }
        .btn-primary.mt-7 { /* Specificity for the Check button */
            margin-top: 1.75rem; /* 28px */
            padding: 0.5rem 1rem; /* Smaller button */
        }
        .label-text {
            color: var(--text-secondary);
            font-weight: 500;
        }
        .required-star {
            color: var(--accent-primary);
            font-weight: 600;
        }
        .result-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 0.5rem;
        }
        .result-title {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
        }
        .result-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        .result-time {
            color: var(--accent-primary);
            font-size: 1.75rem;
            font-weight: 700;
        }
        .afk-suggestion {
            background-color: #4a5568;
            border: 1px solid #38b2ac;
        }
        .milestone-toggle {
            cursor: pointer;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            padding: 0.5rem 0;
            margin-top: 0.75rem;
            border-top: 1px solid var(--bg-tertiary);
        }
        .milestone-toggle:hover {
            color: var(--text-primary);
        }
        .milestone-toggle svg {
            transition: transform 0.2s;
            width: 1.25rem;
            height: 1.25rem;
        }
        .milestone-toggle[aria-expanded="true"] svg {
            transform: rotate(180deg);
        }
        .milestone-list-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0.25rem;
            border-bottom: 1px solid var(--bg-tertiary);
        }
        .milestone-list-item:last-child {
            border-bottom: none;
        }
        .milestone-label {
            color: var(--text-secondary);
        }
        .milestone-time {
            color: var(--text-primary);
            font-weight: 500;
        }
        /* Simple accordion toggle for fossil timings */
        .accordion-toggle {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            padding-top: 0.75rem;
            margin-top: 0.75rem;
            border-top: 1px solid var(--bg-tertiary);
        }
        .accordion-toggle:hover {
            color: var(--text-primary);
        }
        .accordion-toggle svg {
            transition: transform 0.2s;
        }
        .accordion-toggle[aria-expanded="true"] svg {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-3xl mx-auto">
        
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-white mb-2">ZA Shiny Hunt Calculator</h1>
            <p class="text-lg text-gray-400">Calculate your hunt time based on spawns and resets.</p>
            <div class="text-sm text-gray-400 mt-4 border-t border-gray-700 pt-3">
                <p class="font-semibold">Created by: Canadian Guy Eh</p>
                <p>Pokemon Channel - <a href="https://www.youtube.com/@TheShinyCanuck" target="_blank" rel="noopener noreferrer" class="text-accent-primary hover:text-accent-secondary underline">Here</a></p>
                <p>Main Channel - <a href="https://www.youtube.com/@CanadianGuyEh" target="_blank" rel="noopener noreferrer" class="text-accent-primary hover:text-accent-secondary underline">Here</a></p>
            </div>
        </div>

        <!-- NEW: Simple/Advanced/Fossil Toggle -->
        <div class="flex rounded-md shadow-sm mb-4">
            <button id="simpleBtn" class="toggle-btn-active w-1/3 p-2 rounded-l-md focus:outline-none">Simple</button>
            <button id="advancedBtn" class="toggle-btn-inactive w-1/3 p-2 focus:outline-none">Advanced</button>
            <button id="fossilBtn" class="toggle-btn-inactive w-1/3 p-2 rounded-r-md focus:outline-none">Fossils (WIP)</button>
        </div>

        <!-- NEW: Overworld Calculator (Simple/Advanced) -->
        <div id="simpleAdvancedCalculator">
            <!-- Calculator Form -->
            <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-lg mb-6">
                
                <!-- Core Options (Always Visible) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="shinyCharm" class="block text-sm label-text mb-1">Do you have the shiny charm? <span class="required-star">*</span></label>
                        <select id="shinyCharm" class="form-select">
                            <option value="yes">Yes (1/1024.38)</option>
                            <option value="no">No (1/4096)</option>
                        </select>
                    </div>
                    <div>
                        <label for="totalSpawns" class="block text-sm label-text mb-1">Total Pokémon per reset? <span class="required-star">*</span></label>
                        <input type="number" id="totalSpawns" class="form-input" placeholder="e.g., 12">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="resetMethod" class="block text-sm label-text mb-1">Reset Method <span class="required-star">*</span></label>
                    <select id="resetMethod" class="form-select mb-2">
                        <option value="" selected disabled>Select reset method</option>
                        <option value="bench">Bench (19s)</option>
                        <option value="fasttravel">Fast Travel (5s)</option>
                        <option value="custom">Custom</option>
                    </select>
                    <div id="customResetTimeContainer" class="toggle-hidden">
                        <label for="resetTime" class="block text-sm label-text mb-1">Custom Reset Time (seconds)? <span class="required-star">*</span></label>
                        <input type="number" id="resetTime" class="form-input" placeholder="e.g., 5.5">
                    </div>
                </div>

                <!-- AFK Hunt Toggle -->
                <div class="mb-4">
                    <label for="afkHunt" class="block text-sm label-text mb-1">Is this an AFK hunt? <span class="italic font-normal">(optional)</span></label>
                    <select id="afkHunt" class="form-select">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>

                <!-- Advanced Options (Toggled) -->
                <div id="advancedOptions" class="toggle-hidden border-t border-gray-700 pt-6 mt-6">
                    
                    <!-- Specific Hunt -->
                    <h3 class="text-lg font-semibold text-white mb-3">Specific Pokémon Hunt (Optional)</h3>
                    <p class="text-base text-gray-400 mb-3">
                        For specific Pokémon details, check Serebii <a href="https://www.serebii.net/pokearth/lumiosecity/" target="_blank" rel="noopener noreferrer" class="text-accent-primary hover:text-accent-secondary underline">here</a>.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="specificSpawns" class="block text-sm label-text mb-1">How Many Targeted Pokemon Spawns?</label>
                            <input type="number" id="specificSpawns" class="form-input" placeholder="e.g., 3">
                        </div>
                        <div>
                            <label for="spawnPercentMethod" class="block text-sm label-text mb-1">Spawn Table %?</label>
                            <select id="spawnPercentMethod" class="form-select mb-2">
                                <option value="" selected disabled>Select spawn type</option>
                                <option value="isolated">Isolated (100%)</option>
                                <option value="custom">Custom %</option>
                            </select>
                            <div id="customSpawnPercentContainer" class="toggle-hidden">
                                <label for="spawnPercent" class="block text-sm label-text mb-1">Custom Spawn %?</label>
                                <input type="number" id="spawnPercent" class="form-input" placeholder="e.g., 15">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="dayNightLock" class="form-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-accent-primary focus:ring-accent-secondary">
                            <span class="label-text">Is this a Day/Night-locked spawn?</span>
                        </label>
                        <p class="text-xs text-gray-500 ml-7 mt-1">(Doubles Bench reset time for this specific calculation)</p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="specificGender" class="form-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-accent-primary focus:ring-accent-secondary">
                            <span class="label-text">Specific Gender?</span>
                        </label>
                    </div>
                    <div id="genderRateContainer" class="toggle-hidden mb-4 ml-7">
                        <label for="genderRate" class="block text-sm label-text mb-1">Rate of Desired Gender (%)?</label>
                        <input type="number" id="genderRate" class="form-input" value="50" placeholder="e.g., 50">
                        <p class="text-xs text-gray-500 mt-1">e.g., 50% is Default. See Serebii to Double Check.</p>
                    </div>

                    <div class="mb-4">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="includeRespawnTime" class="form-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-accent-primary focus:ring-accent-secondary">
                            <span class="label-text">Include "Wrong Shiny" Respawn Time?</span>
                        </label>
                        <p class="text-xs text-yellow-400 ml-7 mt-1">NOT Recommended for Total AFK Hunts</p>
                        <p id="respawnHelper" class="text-xs text-gray-500 ml-7 mt-1 toggle-hidden">(Disabled: Hunt has no "wrong shiny" condition)</p>
                    </div>
                    <div id="respawnTimeContainer" class="toggle-hidden mb-4 ml-7">
                        <label for="spawnerRespawnTime" class="block text-sm label-text mb-1">Spawner Respawn Time (seconds)?</label>
                        <input type="number" id="spawnerRespawnTime" class="form-input" placeholder="e.g., 150">
                        <p class="text-xs text-gray-500 mt-1">Assumes a 1-minute "clear time" to catch/defeat the wrong shiny.</p>
                    </div>

                    <div class="mb-4 pt-4 border-t border-gray-700">
                        <label for="oddballSpawns" class="block text-sm label-text mb-1">Oddball Spawns (Info Only)</label>
                        <select id="oddballSpawns" class="form-select">
                            <option value="" selected>Select an Oddball Spawn for info...</option>
                            <option value="fossil">Tyrunt, Aerodactyl, Amaura</option>
                            <option value="drampa">Drampa</option>
                            <option value="goomy">Goomy/Sliggoo</option>
                            <option value="riolu">Riolu</option>
                            <option value="helioptile">Helioptile</option>
                            <option value="skarmory">Skarmory</option>
                            <option value="pumpkaboo">Pumpkaboo</option>
                        </select>
                    </div>
                    <div id="oddballExplainerBox" class="toggle-hidden mb-4 p-4 rounded-md bg-gray-800 border border-gray-700">
                        <p id="oddballExplainerText" class="text-sm text-gray-300"></p>
                    </div>

                    <!-- Alpha Hunt -->
                    <h3 class="text-lg font-semibold text-white mb-3 mt-6 pt-4 border-t border-gray-700">Alpha Pokémon Hunt (Optional)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="includeAlphas" class="block text-sm label-text mb-1">Include Alphas in hunt?</label>
                            <select id="includeAlphas" class="form-select">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                    </div>

                    <div id="alphaHuntOptionsContainer" class="toggle-hidden space-y-4">
                        
                        <div class="p-4 rounded-md" style="background-color: var(--bg-primary);">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="includeGuaranteedAlphas" class="form-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-accent-primary focus:ring-accent-secondary">
                                <span class="label-text text-base">Include Guaranteed Alphas?</span>
                            </label>
                            <div id="guaranteedAlphaContainer" class="toggle-hidden mt-4">
                                <label for="guaranteedAlphaCount" class="block text-sm label-text mb-1">How many Guaranteed Alphas in range?</label>
                                <input type="number" id="guaranteedAlphaCount" class="form-input" placeholder="e.g., 1">
                            </div>
                        </div>

                        <div class="p-4 rounded-md" style="background-color: var(--bg-primary);">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="includeNonGuaranteedAlphas" class="form-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-accent-primary focus:ring-accent-secondary">
                                <span class="label-text text-base">Include Non-Guaranteed Alphas?</span>
                            </label>
                            <div id="nonGuaranteedAlphaContainer" class="toggle-hidden mt-4 space-y-4">
                                <div>
                                    <label for="totalAlphaPotential" class="block text-sm label-text mb-1">Total Alpha Potential Spawns</label>
                                    <input type="number" id="totalAlphaPotential" class="form-input read-only-display" placeholder="Auto-filled" readonly>
                                    <p class="text-xs text-gray-500 mt-1">Auto-filled based on Total Spawns - Guaranteed Alphas.</p>
                                </div>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                    <div>
                                        <label for="nonStaticSpawns_0" class="block text-sm label-text mb-1">0% Alpha Chance</label>
                                        <input type="number" id="nonStaticSpawns_0" class="form-input non-guaranteed-input" placeholder="e.g., 3" min="0">
                                    </div>
                                    <div>
                                        <label for="nonStaticSpawns_5" class="block text-sm label-text mb-1">5% Alpha Chance</label>
                                        <input type="number" id="nonStaticSpawns_5" class="form-input non-guaranteed-input" placeholder="e.g., 5" min="0">
                                    </div>
                                    <div>
                                        <label for="nonStaticSpawns_20" class="block text-sm label-text mb-1">20% Alpha Chance</label>
                                        <input type="number" id="nonStaticSpawns_20" class="form-input non-guaranteed-input" placeholder="e.g., 1" min="0">
                                    </div>
                                </div>
                                <p id="nonGuaranteedAlphaError" class="text-red-500 text-sm toggle-hidden">Invalid: Total exceeds max "Alpha Potential" spawns.</p>

                                <div>
                                    <label class="flex items-center space-x-2 pt-4 border-t border-gray-700">
                                        <input type="checkbox" id="specificShinyAlpha" class="form-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-accent-primary focus:ring-accent-secondary">
                                        <span class="label-text">Looking for a SPECIFIC Shiny Alpha?</span>
                                    </label>
                                    <p class="text-xs text-gray-500 ml-7">Uses info from "Specific Pokémon Hunt" section. (Applies to Non-Guaranteed only)</p>
                                </div>
                                
                                <div id="specificAlphaChanceContainer" class="toggle-hidden ml-7">
                                    <label for="specificAlphaChance" class="block text-sm label-text mb-1">Alpha % of your specific target?</label>
                                    <select id="specificAlphaChance" class="form-select">
                                        <option value="0.05">5% Chance</option>
                                        <option value="0.20">20% Chance</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Time Loss -->
                    <h3 class="text-lg font-semibold text-white mb-3 mt-6 pt-4 border-t border-gray-700">Time Loss Factors (Optional)</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div id="dayNightContainer">
                            <label for="dayNightCycle" class="block text-sm label-text mb-1">Include Day/Night cinematics?</label>
                            <select id="dayNightCycle" class="form-select">
                                <option value="no">No</option>
                                <option value="yes">Yes (Adds 12s per 24m)</option>
                            </select>
                            <p id="dayNightHelper" class="text-xs text-gray-500 mt-1 toggle-hidden">(Disabled: Method includes or pauses time cycle)</p>
                        </div>
                    </div>
                </div>

                <!-- Calculate Button -->
                <button id="calculateBtn" class="btn-primary w-full mt-4">Calculate Hunt</button>
                
                <p class="text-center text-yellow-400 text-base mt-6">
                    Want to support my work? Donate <a href="https://streamlabs.com/canadianguyeh/tip" target="_blank" rel="noopener noreferrer" class="text-accent-primary hover:text-accent-secondary underline">here</a>!
                </p>

            </div>
        </div>
        
        <!-- NEW: Fossil Calculator -->
        <div id="fossilCalculator" class="toggle-hidden">
            <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-lg mb-6">
                <h2 class="text-2xl font-bold text-white mb-4">Fossil Hunt Calculator</h2>
                <p class="text-sm text-gray-400 mb-4">
                    For soft-resetting fossils. Shiny Charm does NOT apply (odds are 1/4096).
                </p>
                
                <div class="mb-4">
                    <label for="fossilsPerReset" class="block text-sm label-text mb-1">How many fossils per reset? <span class="required-star">*</span></label>
                    <input type="number" id="fossilsPerReset" class="form-input" placeholder="e.g., 30 (1 box)">
                </div>

                <div class="mb-6 p-3 rounded-md bg-gray-800 border border-gray-700">
                    <h4 class="font-semibold text-accent-primary">Pro-Tip: Finding the "Sweet Spot"</h4>
                    <p class="text-sm text-gray-300 mt-1">
                        To maximize your "Fossils per Minute," we recommend restoring a full box (30 fossils) or a full party (6 fossils) at a time. The more fossils you restore per loop, the more efficient your hunt will be!
                    </p>
                </div>

                <!-- NEW: Fossil Timing Accordion -->
                <div class="mb-6">
                    <button class="accordion-toggle" id="fossilTimingToggle" aria-expanded="false">
                        <span>Adjust Reset Timing (Optional)</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                          <path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div id="fossilTimingContainer" class="toggle-hidden mt-4 p-4 rounded-md" style="background-color: var(--bg-primary);">
                        <p class="text-sm text-gray-400 mb-3">
                            Override the default timings if your hardware is faster/slower.
                        </p>
                        <div class="space-y-3">
                            <div>
                                <label for="fossilFixedTime" class="block text-sm label-text mb-1">Fixed Time (sec)</label>
                                <input type="number" id="fossilFixedTime" class="form-input" placeholder="Default: 30">
                                <p class="text-xs text-gray-500 mt-1">"Time tax" for reload, menus, first check.</p>
                            </div>
                            <div>
                                <label for="fossilScalingTime" class="block text-sm label-text mb-1">Time per Fossil (sec)</label>
                                <input type="number" id="fossilScalingTime" class="form-input" placeholder="Default: 15">
                                <p class="text-xs text-gray-500 mt-1">Additional time to restore & check each fossil.</p>
                            </div>
                            <div>
                                <label for="fossilRestoreTime" class="block text-sm label-text mb-1">Restore-Only Time (sec)</label>
                                <input type="number" id="fossilRestoreTime" class="form-input" placeholder="Default: 14.5">
                                <p class="text-xs text-gray-500 mt-1">Used for AFK suggestion (restore-phase only).</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- END: Fossil Timing Accordion -->

                <button id="calculateFossilBtn" class="btn-primary w-full">Calculate Fossil Hunt</button>
                
                <p class="text-center text-yellow-400 text-base mt-6">
                    Want to support my work? Donate <a href="https://streamlabs.com/canadianguyeh/tip" target="_blank" rel="noopener noreferrer" class="text-accent-primary hover:text-accent-secondary underline">here</a>!
                </p>
            </div>
        </div>


        <!-- Error Area -->
        <div id="errorArea" class="hidden p-4 bg-red-800 border border-error-primary text-white rounded-lg mb-6">
            <!-- Errors will be injected here -->
        </div>

        <!-- Results Area -->
        <div id="resultsArea" class="hidden">
            <div id="resultsContainer" class="space-y-4">
                <!-- Results will be injected here -->
            </div>
            
            <div id="afkSuggestionBox" class="hidden p-4 rounded-lg mt-6 afk-suggestion">
                <h3 class="text-lg font-semibold text-white mb-2">AFK Hunt Suggestion</h3>
                <p id="afkSuggestionText" class="text-gray-200"></p>
            </div>
            
            <div id="reverseProbabilityBox" class="hidden p-4 rounded-lg mt-6 bg-secondary border border-tertiary">
                <h3 class="text-lg font-semibold text-white mb-3">Have limited time?</h3>
                <p class="text-gray-400 mb-4">Input your time and we'll tell you the chances of getting your target!</p>
                <div class="flex items-start gap-4 mb-3">
                    <div class="flex-1">
                        <label for="probTimeHours" class="block text-sm label-text mb-1">Hours (0-23)</label>
                        <input type="number" id="probTimeHours" class="form-input" placeholder="e.g., 2" min="0" max="23">
                    </div>
                    <div class="flex-1">
                        <label for="probTimeMinutes" class="block text-sm label-text mb-1">Minutes (0-59)</label>
                        <input type="number" id="probTimeMinutes" class="form-input" placeholder="e.g., 30" min="0" max="59">
                    </div>
                    <button id="probTimeBtn" class="btn-primary mt-7">Check</button>
                </div>
                <p id="probTimeError" class="text-red-500 text-sm mb-3"></p>
                <div id="probTimeResults" class="space-y-2">
                    <!-- Probability results will be injected here -->
                </div>
            </div>
            
        </div>

    </div>

    <script>
        // --- Global Store for Reverse Calc ---
        let calculatedAverages = {};
    
        // --- Element Grabbing ---
        const simpleBtn = document.getElementById('simpleBtn');
        const advancedBtn = document.getElementById('advancedBtn');
        const fossilBtn = document.getElementById('fossilBtn');
        
        const simpleAdvancedCalculator = document.getElementById('simpleAdvancedCalculator');
        const fossilCalculator = document.getElementById('fossilCalculator');
        
        const advancedOptions = document.getElementById('advancedOptions');

        const resetMethod = document.getElementById('resetMethod');
        const customResetTimeContainer = document.getElementById('customResetTimeContainer');

        const spawnPercentMethod = document.getElementById('spawnPercentMethod');
        const customSpawnPercentContainer = document.getElementById('customSpawnPercentContainer');
        const dayNightLock = document.getElementById('dayNightLock');
        
        const specificGender = document.getElementById('specificGender');
        const genderRateContainer = document.getElementById('genderRateContainer');

        const includeRespawnTime = document.getElementById('includeRespawnTime');
        const respawnTimeContainer = document.getElementById('respawnTimeContainer');
        const respawnHelper = document.getElementById('respawnHelper');

        const includeAlphas = document.getElementById('includeAlphas');
        const alphaHuntOptionsContainer = document.getElementById('alphaHuntOptionsContainer');
        const includeGuaranteedAlphas = document.getElementById('includeGuaranteedAlphas');
        const guaranteedAlphaContainer = document.getElementById('guaranteedAlphaContainer');
        const guaranteedAlphaCount = document.getElementById('guaranteedAlphaCount');
        const includeNonGuaranteedAlphas = document.getElementById('includeNonGuaranteedAlphas');
        const nonGuaranteedAlphaContainer = document.getElementById('nonGuaranteedAlphaContainer');
        const totalSpawnsInput = document.getElementById('totalSpawns');
        
        const totalAlphaPotential = document.getElementById('totalAlphaPotential');
        const nonStaticSpawns_0 = document.getElementById('nonStaticSpawns_0');
        const nonStaticSpawns_5 = document.getElementById('nonStaticSpawns_5');
        const nonStaticSpawns_20 = document.getElementById('nonStaticSpawns_20');
        const nonGuaranteedAlphaError = document.getElementById('nonGuaranteedAlphaError');
        const nonGuaranteedInputs = document.querySelectorAll('.non-guaranteed-input');
        
        const specificShinyAlpha = document.getElementById('specificShinyAlpha');
        const specificAlphaChanceContainer = document.getElementById('specificAlphaChanceContainer');
        
        const dayNightCycle = document.getElementById('dayNightCycle');
        const dayNightHelper = document.getElementById('dayNightHelper');
        
        const calculateBtn = document.getElementById('calculateBtn');
        const calculateFossilBtn = document.getElementById('calculateFossilBtn');
        
        const resultsArea = document.getElementById('resultsArea');
        const resultsContainer = document.getElementById('resultsContainer');
        const errorArea = document.getElementById('errorArea');
        const afkSuggestionBox = document.getElementById('afkSuggestionBox');
        const afkSuggestionText = document.getElementById('afkSuggestionText');
        
        const reverseProbabilityBox = document.getElementById('reverseProbabilityBox');
        const probTimeBtn = document.getElementById('probTimeBtn');
        const probTimeHours = document.getElementById('probTimeHours');
        const probTimeMinutes = document.getElementById('probTimeMinutes');
        const probTimeError = document.getElementById('probTimeError');
        const probTimeResults = document.getElementById('probTimeResults');

        const oddballSpawns = document.getElementById('oddballSpawns');
        const oddballExplainerBox = document.getElementById('oddballExplainerBox');
        const oddballExplainerText = document.getElementById('oddballExplainerText');
        
        // NEW: Fossil Timing Elements
        const fossilTimingToggle = document.getElementById('fossilTimingToggle');
        const fossilTimingContainer = document.getElementById('fossilTimingContainer');
        const fossilFixedTime = document.getElementById('fossilFixedTime');
        const fossilScalingTime = document.getElementById('fossilScalingTime');
        const fossilRestoreTime = document.getElementById('fossilRestoreTime');

        const oddballInfo = {
            "fossil": "Tyrunt, Aerodactyl, Amaura - These are Fossil Pokémon. Please Use the Fossil Tab.",
            "drampa": "Drampa - Drampa can be shiny hunted, however, it spawns in Wild Zone 19 and only during the early morning. There's no way to be able to calculate the time for the hunt consistently as it would require a system reset part way through the hunt. There are also no benches nearby so that can't be used either. Overall, while the hunt is of course not impossible, this calculator may not be the best use for this hunt.",
            "goomy": "Goomy/Sliggoo - These Pokémon only spawn when it is raining. Your best bet is to Bench until it rains in your game, find your spawn, and use either a custom or fast travel method. I don't suggest a total afk hunt for this one. If a shiny does spawn, and you miss it, you won't know until it rains again. Calculator is still useable, but requires attention.",
            "riolu": "Riolu - This Pokémon Only Spawns during Intense Sun. Your best bet is to Bench until it is Very Sunny, find your spawn, and use either a custom or fast travel method. I don't suggest a total afk hunt for this one. If a shiny does spawn, and you miss it, you won't know until it's very sunny again. Calculator is still useable, but requires attention.",
            "helioptile": "Helioptile - This Pokémon Only Spawns during Intense Sun. Your best bet is to Bench until it is Very Sunny, find your spawn, and use either a custom or fast travel method. I don't suggest a total afk hunt for this one. If a shiny does spawn, and you miss it, you won't know until it's very sunny again. Calculator is still useable, but requires attention.",
            "skarmory": "Skarmory - This pokemon is still very valid for the calculator. However, if it rains in game, the pokemon will not spawn. So timing maybe be inconclusive in our estimates.",
            "pumpkaboo": "Pumpkaboo - Pumpkaboo is handled very oddly. Due to its size variants between day and night it for some reason doesn't save properly to the shiny stash if you switch from day to night or night to day. the Calculator can still be a help, but DO NOT BENCH and dont do this AFK. Strictly custom or fast travel."
        };

        // --- UI Toggles ---

        simpleBtn.addEventListener('click', () => {
            simpleAdvancedCalculator.classList.remove('toggle-hidden');
            fossilCalculator.classList.add('toggle-hidden');

            advancedOptions.classList.add('toggle-hidden');
            simpleBtn.classList.add('toggle-btn-active');
            simpleBtn.classList.remove('toggle-btn-inactive');
            advancedBtn.classList.add('toggle-btn-inactive');
            advancedBtn.classList.remove('toggle-btn-active');
            fossilBtn.classList.add('toggle-btn-inactive');
            fossilBtn.classList.remove('toggle-btn-active');

            clearResults();
            resetAdvancedFields();
        });

        advancedBtn.addEventListener('click', () => {
            simpleAdvancedCalculator.classList.remove('toggle-hidden');
            fossilCalculator.classList.add('toggle-hidden');

            advancedOptions.classList.remove('toggle-hidden');
            advancedBtn.classList.add('toggle-btn-active');
            advancedBtn.classList.remove('toggle-btn-inactive');
            simpleBtn.classList.add('toggle-btn-inactive');
            simpleBtn.classList.remove('toggle-btn-active');
            fossilBtn.classList.add('toggle-btn-inactive');
            fossilBtn.classList.remove('toggle-btn-active');
            
            clearResults();
        });

        fossilBtn.addEventListener('click', () => {
            simpleAdvancedCalculator.classList.add('toggle-hidden');
            fossilCalculator.classList.remove('toggle-hidden');

            fossilBtn.classList.add('toggle-btn-active');
            fossilBtn.classList.remove('toggle-btn-inactive');
            simpleBtn.classList.add('toggle-btn-inactive');
            simpleBtn.classList.remove('toggle-btn-active');
            advancedBtn.classList.add('toggle-btn-inactive');
            advancedBtn.classList.remove('toggle-btn-active');
            
            clearResults();
        });


        resetMethod.addEventListener('change', () => {
            if (resetMethod.value === 'custom') {
                customResetTimeContainer.classList.remove('toggle-hidden');
            } else {
                customResetTimeContainer.classList.add('toggle-hidden');
            }

            if (resetMethod.value === 'bench' || resetMethod.value === 'fasttravel') {
                dayNightCycle.value = 'no';
                dayNightCycle.disabled = true;
                dayNightHelper.classList.remove('toggle-hidden');
            } else {
                dayNightCycle.disabled = false;
                dayNightHelper.classList.add('toggle-hidden');
            }
        });

        oddballSpawns.addEventListener('change', () => {
            const selectedValue = oddballSpawns.value;
            if (selectedValue && oddballInfo[selectedValue]) {
                oddballExplainerText.textContent = oddballInfo[selectedValue];
                oddballExplainerBox.classList.remove('toggle-hidden');
            } else {
                oddballExplainerBox.classList.add('toggle-hidden');
            }
        });

        resultsContainer.addEventListener('click', (e) => {
            const toggle = e.target.closest('.milestone-toggle');
            if (toggle) {
                const targetId = toggle.dataset.target;
                const targetDiv = document.getElementById(targetId);
                if (targetDiv) {
                    const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
                    if (isExpanded) {
                        targetDiv.classList.add('toggle-hidden');
                        toggle.setAttribute('aria-expanded', 'false');
                    } else {
                        targetDiv.classList.remove('toggle-hidden');
                        toggle.setAttribute('aria-expanded', 'true');
                    }
                }
            }
        });
        
        spawnPercentMethod.addEventListener('change', () => {
            if (spawnPercentMethod.value === 'custom') {
                customSpawnPercentContainer.classList.remove('toggle-hidden');
            } else {
                customSpawnPercentContainer.classList.add('toggle-hidden');
            }
            updateRespawnTimeStatus();
        });
        
        specificGender.addEventListener('change', () => {
            if (specificGender.checked) {
                genderRateContainer.classList.remove('toggle-hidden');
            } else {
                genderRateContainer.classList.add('toggle-hidden');
            }
            updateRespawnTimeStatus();
        });

        includeRespawnTime.addEventListener('change', () => {
            if (includeRespawnTime.checked) {
                respawnTimeContainer.classList.remove('toggle-hidden');
            } else {
                respawnTimeContainer.classList.add('toggle-hidden');
            }
        });
        
        function updateRespawnTimeStatus() {
            const isIsolated = spawnPercentMethod.value === 'isolated';
            const isGenderLocked = specificGender.checked;
            
            const noWrongShinies = isIsolated && !isGenderLocked;
            
            if (noWrongShinies) {
                includeRespawnTime.checked = false;
                includeRespawnTime.disabled = true;
                respawnHelper.classList.remove('toggle-hidden');
            } else {
                includeRespawnTime.disabled = false;
                respawnHelper.classList.add('toggle-hidden');
            }
            
            if (!includeRespawnTime.checked) {
                respawnTimeContainer.classList.add('toggle-hidden');
            }
        }
        
        // --- Calculation ---
        
        calculateBtn.addEventListener('click', () => {
            clearResults();
            calculatedAverages = {}; // Reset global store
            
            // --- Get All Input Values ---
            
            const hasCharm = document.getElementById('shinyCharm').value === 'yes';
            const totalSpawns = parseFloat(document.getElementById('totalSpawns').value);
            
            const resetMethodValue = document.getElementById('resetMethod').value;
            let baseResetTime;
            if (resetMethodValue === 'bench') {
                baseResetTime = 19;
            } else if (resetMethodValue === 'fasttravel') {
                baseResetTime = 5;
            } else if (resetMethodValue === 'custom') {
                baseResetTime = parseFloat(document.getElementById('resetTime').value);
            } else {
                baseResetTime = NaN;
            }
            
            const isAfkHunt = document.getElementById('afkHunt').value === 'yes';
            
            // Advanced (Optional)
            const specificSpawns = parseFloat(document.getElementById('specificSpawns').value) || 0;
            const spawnPercentMethodValue = document.getElementById('spawnPercentMethod').value;
            let spawnPercent = 0;
            if (spawnPercentMethodValue === 'isolated') {
                spawnPercent = 100;
            } else if (spawnPercentMethodValue === 'custom') {
                spawnPercent = parseFloat(document.getElementById('spawnPercent').value) || 0;
            }
            
            const isDayNightLocked = document.getElementById('dayNightLock').checked;
            
            const isSpecificGender = document.getElementById('specificGender').checked;
            const genderRate = (parseFloat(document.getElementById('genderRate').value) || 50) / 100.0;
            const genderMultiplier = isSpecificGender ? genderRate : 1.0;
            const genderSubtitle = isSpecificGender ? ` & ${genderRate * 100}% gender` : '';

            const includeRespawn = document.getElementById('includeRespawnTime').checked;
            const spawnerRespawnTime = parseFloat(document.getElementById('spawnerRespawnTime').value) || 0;
            const clearTime = 60;

            const doAlphaHunt = document.getElementById('includeAlphas').value === 'yes';
            const doIncludeGuaranteedAlphas = document.getElementById('includeGuaranteedAlphas').checked;
            const guaranteedAlphaCountVal = doIncludeGuaranteedAlphas ? (parseFloat(document.getElementById('guaranteedAlphaCount').value) || 0) : 0;
            const doIncludeNonGuaranteedAlphas = document.getElementById('includeNonGuaranteedAlphas').checked;
            
            const spawns_0 = parseFloat(nonStaticSpawns_0.value) || 0;
            const spawns_5 = parseFloat(nonStaticSpawns_5.value) || 0;
            const spawns_20 = parseFloat(nonStaticSpawns_20.value) || 0;
            
            const specificShinyAlpha = document.getElementById('specificShinyAlpha').checked;
            const specificAlphaChance = parseFloat(document.getElementById('specificAlphaChance').value) || 0; // For Trifecta

            const includeDayNight = document.getElementById('dayNightCycle').value === 'yes';

            // --- Validation ---
            if (isNaN(totalSpawns) || isNaN(baseResetTime) || totalSpawns <= 0 || baseResetTime <= 0) {
                errorArea.innerHTML = 'Please fill out all required fields (*) with numbers greater than 0.';
                errorArea.classList.remove('hidden');
                return;
            }

            if (doAlphaHunt && doIncludeNonGuaranteedAlphas && !validateNonStaticSpawns()) {
                errorArea.innerHTML = 'Non-Guaranteed Alpha spawns exceed the total available. Please check your numbers.';
                errorArea.classList.remove('hidden');
                return;
            }

            // --- Base Calculation ---
            const baseOdds = hasCharm ? 1024.38 : 4096;
            
            const runCalc = (spawns, odds = baseOdds, resetTime = baseResetTime) => {
                if (spawns <= 0) return { avgResets: 0, totalSeconds: 0 };
                const totalChancePerReset = (1.0 / odds) * spawns;
                if (totalChancePerReset <= 0) return { avgResets: 0, totalSeconds: 0 };
                const avgResets = 1.0 / totalChancePerReset;
                const totalSeconds = avgResets * resetTime;
                return { avgResets, totalSeconds };
            };

            // --- Run All Calculations ---
            resultsArea.classList.remove('hidden');

            // 1. Avg. Time for ANY Shiny (Total Spawns)
            const calc1 = runCalc(totalSpawns, baseOdds, baseResetTime);
            if (calc1.totalSeconds > 0) {
                displayResult(
                    'Avg. Time for ANY Shiny',
                    calc1.avgResets,
                    calc1.totalSeconds,
                    `Based on ${totalSpawns} total spawners`
                );
            }

            // 2. Avg. Time for SPECIFIC Shiny
            if (specificSpawns > 0 && spawnPercent > 0) {
                
                let specificResetTime = baseResetTime;
                let specificSubtitle = `Based on ${specificSpawns} spawners at ${spawnPercent}%${genderSubtitle}`;
                if (spawnPercentMethodValue === 'isolated') {
                    specificSubtitle = `Based on ${specificSpawns} isolated (100%) spawners${genderSubtitle}`;
                }

                if (isDayNightLocked && resetMethodValue === 'bench') {
                    specificResetTime = 19 * 2; // 38 seconds
                    specificSubtitle += ` (38s reset; 2 bench cycles per roll)`;
                }

                const spawnRate = spawnPercent / 100.0;
                const probPerSpawner = (1.0 / baseOdds) * spawnRate * genderMultiplier;
                const totalChancePerReset = probPerSpawner * specificSpawns;
                
                if (totalChancePerReset > 0) {
                    const avgResets_base = 1.0 / totalChancePerReset;
                    const totalSeconds_base = avgResets_base * specificResetTime;

                    let totalSeconds_specific = totalSeconds_base;
                    let avgResets_specific = avgResets_base;
                    let subtitle = specificSubtitle;

                    if (includeRespawn && !includeRespawnTime.disabled && spawnerRespawnTime > 0) {
                        const probOfTarget = spawnRate * genderMultiplier;
                        let probOfWrong;
                        if (spawnPercentMethodValue === 'isolated') {
                            probOfWrong = (1.0 - genderMultiplier);
                        } else {
                            probOfWrong = 1.0 - probOfTarget;
                        }
                        
                        const expectedWrongShinies = (probOfTarget > 0) ? (probOfWrong / probOfTarget) : 0;
                        
                        const timeCostPerWrongShiny = clearTime + (spawnerRespawnTime / specificSpawns);
                        const totalPenaltySeconds = expectedWrongShinies * timeCostPerWrongShiny;
                        
                        totalSeconds_specific = totalSeconds_base + totalPenaltySeconds;
                        avgResets_specific = totalSeconds_specific / specificResetTime; 

                        const penaltyTime = formatTime(totalPenaltySeconds);
                        subtitle = `Includes ${penaltyTime.hours}h ${penaltyTime.minutes}m ${penaltyTime.seconds}s of "Wrong Shiny" penalty time`;
                        if (isDayNightLocked && resetMethodValue === 'bench') {
                            subtitle += ` (38s reset)`;
                        }
                    }
                    
                    displayResult(
                        'Avg. Time for SPECIFIC Shiny',
                        avgResets_specific,
                        totalSeconds_specific,
                        subtitle
                    );
                }
            }

            // 3. Alpha Hunt
            if (doAlphaHunt && (doIncludeGuaranteedAlphas || doIncludeNonGuaranteedAlphas)) {
                
                let totalExpectedAlphas = 0;
                let subtitleParts = [];

                if (doIncludeGuaranteedAlphas && guaranteedAlphaCountVal > 0) {
                    totalExpectedAlphas += guaranteedAlphaCountVal;
                    subtitleParts.push(`${guaranteedAlphaCountVal} guaranteed`);
                    
                    const calc_static_only = runCalc(guaranteedAlphaCountVal, baseOdds, baseResetTime);
                    if (calc_static_only.totalSeconds > 0) {
                        displayResult(
                            'Avg. Time for GUARANTEED Shiny Alphas',
                            calc_static_only.avgResets,
                            calc_static_only.totalSeconds,
                            `Based on ${guaranteedAlphaCountVal} guaranteed spawner(s) only`
                        );
                    }
                }
                
                if (doIncludeNonGuaranteedAlphas) {
                    const expectedNonStatic = (spawns_5 * 0.05) + (spawns_20 * 0.20);
                    if (expectedNonStatic > 0) {
                        totalExpectedAlphas += expectedNonStatic;
                        subtitleParts.push(`${expectedNonStatic.toFixed(2)} avg non-guaranteed`);
                    }
                }

                if (totalExpectedAlphas > 0) {
                    const calc3 = runCalc(totalExpectedAlphas, baseOdds, baseResetTime);
                    if (calc3.totalSeconds > 0) {
                        displayResult(
                            'Avg. Time for ANY Shiny Alpha',
                            calc3.avgResets,
                            calc3.totalSeconds,
                            `Based on ${totalExpectedAlphas.toFixed(2)} total expected Alpha(s) (${subtitleParts.join(' + ')})`
                        );
                    }
                }
                
                // 4. Specific Shiny Alpha (Trifecta)
                if (doIncludeNonGuaranteedAlphas && specificShinyAlpha && specificSpawns > 0 && spawnPercent > 0 && specificAlphaChance > 0) {
                    
                    let specificResetTime_trifecta = baseResetTime;
                    let specificSubtitle_trifecta = `The "Trifecta": ${specificSpawns} spawners, ${spawnPercent}% spawn, ${specificAlphaChance * 100}% Alpha${genderSubtitle}`;
                    if (spawnPercentMethodValue === 'isolated') {
                        specificSubtitle_trifecta = `The "Trifecta": ${specificSpawns} isolated spawners, ${specificAlphaChance * 100}% Alpha${genderSubtitle}`;
                    }

                    if (isDayNightLocked && resetMethodValue === 'bench') {
                        specificResetTime_trifecta = 19 * 2; // 38 seconds
                        specificSubtitle_trifecta += ` (38s reset)`;
                    }

                    const trifectaSpawns = specificSpawns;
                    if (trifectaSpawns > 0) {
                        const spawnRate = spawnPercent / 100.0;
                        
                        const probPerSpawner_trifecta = (1.0 / baseOdds) * spawnRate * specificAlphaChance * genderMultiplier;
                        const totalChancePerReset_trifecta = probPerSpawner_trifecta * trifectaSpawns;
                        
                        if (totalChancePerReset_trifecta > 0) {
                            const avgResets_base = 1.0 / totalChancePerReset_trifecta;
                            const totalSeconds_base = avgResets_base * specificResetTime_trifecta;

                            let totalSeconds_trifecta = totalSeconds_base;
                            let avgResets_trifecta = avgResets_base;
                            let subtitle = specificSubtitle_trifecta;

                            if (includeRespawn && !includeRespawnTime.disabled && spawnerRespawnTime > 0) {
                                const probTrifectaTarget = spawnRate * specificAlphaChance * genderMultiplier;
                                
                                let probTrfiectaWrong;
                                if (spawnPercentMethodValue === 'isolated') {
                                    probTrfiectaWrong = 1.0 - (specificAlphaChance * genderMultiplier);
                                } else {
                                    probTrfiectaWrong = 1.0 - probTrifectaTarget;
                                }

                                const expectedWrongShinies = (probTrifectaTarget > 0) ? (probTrfiectaWrong / probTrifectaTarget) : 0;
                                
                                const timeCostPerWrongShiny = clearTime + (spawnerRespawnTime / specificSpawns);
                                const totalPenaltySeconds = expectedWrongShinies * timeCostPerWrongShiny;
                                
                                totalSeconds_trifecta = totalSeconds_base + totalPenaltySeconds;
                                avgResets_trifecta = totalSeconds_trifecta / specificResetTime_trifecta;

                                const penaltyTime = formatTime(totalPenaltySeconds);
                                subtitle = `Includes ${penaltyTime.hours}h ${penaltyTime.minutes}m ${penaltyTime.seconds}s of "Wrong Shiny" penalty time`;
                                if (isDayNightLocked && resetMethodValue === 'bench') {
                                    subtitle += ` (38s reset)`;
                                }
                            }

                            displayResult(
                                'Avg. Time for SPECIFIC Shiny Alpha',
                                avgResets_trifecta,
                                totalSeconds_trifecta,
                                subtitle
                            );
                        }
                    }
                }
            }
            
            // 5. AFK Hunt Suggestion
            if (isAfkHunt && calc1.totalSeconds > 0) {
                const timePerClog_sec = calc1.totalSeconds;
                const penaltyThreshold_sec = 35 * 60;
                
                const time_A = timePerClog_sec * 7;
                
                let time_B = Infinity;
                let clogs_for_penalty = 1;
                for (let i = 1; i < totalSpawns; i++) {
                    const spawnsRemaining = totalSpawns - i;
                    if (spawnsRemaining <= 0) break;
                    
                    const calc_clogged = runCalc(spawnsRemaining, baseOdds, baseResetTime);
                    const penalty_sec = calc_clogged.totalSeconds - calc1.totalSeconds;
                    
                    if (penalty_sec > penaltyThreshold_sec) {
                        clogs_for_penalty = i;
                        time_B = timePerClog_sec * clogs_for_penalty;
                        break;
                    }
                }
                
                let checkInTime_sec = Math.min(time_A, time_B);
                let reason = "";
                
                if (checkInTime_sec === time_A) {
                    reason = `to avoid hitting your 7-shiny soft cap.`;
                } else {
                    const time = formatTime(penaltyThreshold_sec);
                    reason = `to avoid losing hunt efficiency (a ${time.minutes}m+ time penalty).`;
                }
                
                const checkInTime = formatTime(checkInTime_sec);
                afkSuggestionText.innerHTML = `You should check your game every <strong>${checkInTime.hours}h ${checkInTime.minutes}m ${checkInTime.seconds}s</strong> (on average) ${reason}`;
                afkSuggestionBox.classList.remove('hidden');
            }
            
            reverseProbabilityBox.classList.remove('hidden');

        });

        // --- FOSSIL CALCULATOR ---
        calculateFossilBtn.addEventListener('click', () => {
            clearResults();
            calculatedAverages = {}; // Reset global store

            const fossilsPerReset = parseFloat(document.getElementById('fossilsPerReset').value);

            if (isNaN(fossilsPerReset) || fossilsPerReset <= 0) {
                errorArea.innerHTML = 'Please enter a number of fossils greater than 0.';
                errorArea.classList.remove('hidden');
                return;
            }

            resultsArea.classList.remove('hidden');

            // --- Get Custom Timings (or defaults) ---
            const fixedTime = parseFloat(fossilFixedTime.value) || 30;
            const scalingTime = parseFloat(fossilScalingTime.value) || 15;
            const restoreTime = parseFloat(fossilRestoreTime.value) || 14.5;

            // --- Fossil Calculations ---
            const SHINY_ODDS = 4096;
            const ALPHA_ODDS = 100;
            const SHINY_ALPHA_ODDS = 409600;

            // Core Formula: 30s fixed tax + 15s per fossil
            const totalLoopTime = fixedTime + (scalingTime * fossilsPerReset);
            const fossilsPerMin = (fossilsPerReset / totalLoopTime) * 60;

            const avgLoopsShiny = SHINY_ODDS / fossilsPerReset;
            const totalSecondsShiny = avgLoopsShiny * totalLoopTime;

            const avgLoopsAlpha = ALPHA_ODDS / fossilsPerReset;
            const totalSecondsAlpha = avgLoopsAlpha * totalLoopTime;

            const avgLoopsShinyAlpha = SHINY_ALPHA_ODDS / fossilsPerReset;
            const totalSecondsShinyAlpha = avgLoopsShinyAlpha * totalLoopTime;

            // --- Display Results ---

            // 1. Efficiency
            const fossilsPerMinCard = `
                <div class="result-card p-4">
                    <span class="result-title">Hunt Efficiency</span>
                    <div class="result-time" style="font-size: 1.5rem; margin-top: 0.5rem;">
                        ${fossilsPerMin.toFixed(2)} Fossils per Minute
                    </div>
                </div>`;
            resultsContainer.innerHTML += fossilsPerMinCard;

            // 2. Shiny
            displayResult(
                'Avg. Time for SHINY Fossil',
                avgLoopsShiny,
                totalSecondsShiny,
                `Based on ${fossilsPerReset} fossils per reset @ 1/4096`
            );

            // 3. Alpha
            displayResult(
                'Avg. Time for ALPHA Fossil',
                avgLoopsAlpha,
                totalSecondsAlpha,
                `Based on ${fossilsPerReset} fossils per reset @ 1/100`
            );

            // 4. Shiny Alpha
            displayResult(
                'Avg. Time for SHINY ALPHA Fossil',
                avgLoopsShinyAlpha,
                totalSecondsShinyAlpha,
                `Based on ${fossilsPerReset} fossils per reset @ 1/409,600`
            );

            // 5. AFK Suggestion
            // Use the 14.5s * N restore phase time for this suggestion
            const afkRestoreTime = restoreTime * fossilsPerReset; 
            const afkTime = formatTime(afkRestoreTime);
            afkSuggestionText.innerHTML = `With ${fossilsPerReset} fossils, your restore phase (mashing 'A') will take approximately <strong>${afkTime.hours}h ${afkTime.minutes}m ${afkTime.seconds}s</strong>. You should check in after this time to start your box check.`;
            afkSuggestionBox.classList.remove('hidden');
            
            reverseProbabilityBox.classList.remove('hidden');
        });

        // NEW: Fossil Timing Toggle Listener
        fossilTimingToggle.addEventListener('click', () => {
            const isExpanded = fossilTimingToggle.getAttribute('aria-expanded') === 'true';
            if (isExpanded) {
                fossilTimingContainer.classList.add('toggle-hidden');
                fossilTimingToggle.setAttribute('aria-expanded', 'false');
            } else {
                fossilTimingContainer.classList.remove('toggle-hidden');
                fossilTimingToggle.setAttribute('aria-expanded', 'true');
            }
        });

        
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            totalSeconds %= 3600;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            return { hours, minutes, seconds };
        }

        function formatMilestoneTime(totalSeconds) {
            if (totalSeconds < 0 || !isFinite(totalSeconds)) {
                return 'N/A';
            }
            const { hours, minutes, seconds } = formatTime(totalSeconds);
            return `${hours}h ${minutes}m ${seconds}s`;
        }
        
        function buildMilestoneHTML(avgSeconds, uniqueId) {
            // Formula: t = -ln(1 - P) * Time_Avg
            const milestones = [
                { label: 'INSANE! (1%)', time: formatMilestoneTime(-Math.log(1 - 0.01) * avgSeconds) },
                { label: 'You Lucky Ducklett! (10%)', time: formatMilestoneTime(-Math.log(1 - 0.10) * avgSeconds) },
                { label: 'Impressive! (25%)', time: formatMilestoneTime(-Math.log(1 - 0.25) * avgSeconds) },
                { label: 'Larry Would be Proud (50%)', time: formatMilestoneTime(-Math.log(1 - 0.50) * avgSeconds) },
                { label: 'Right on Time! (63.2%)', time: formatMilestoneTime(avgSeconds) }, // This is just the average
                { label: 'Runnin\' Late (80%)', time: formatMilestoneTime(-Math.log(1 - 0.80) * avgSeconds) },
                { label: 'I\'ve Seen Faster Slowpokes (90%)', time: formatMilestoneTime(-Math.log(1 - 0.90) * avgSeconds) },
                { label: 'Please Hunt Something Else... (99%)', time: formatMilestoneTime(-Math.log(1 - 0.99) * avgSeconds) }
            ];

            let listHTML = '';
            milestones.forEach(ms => {
                listHTML += `
                    <li class="milestone-list-item">
                        <span class="milestone-label">${ms.label}</span>
                        <span class="milestone-time">${ms.time}</span>
                    </li>
                `;
            });

            return `
                <button class="milestone-toggle flex justify-between items-center w-full" data-target="milestones-${uniqueId}" aria-expanded="false">
                    <span>Probability Milestones</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="milestones-${uniqueId}" class="toggle-hidden p-2" style="background-color: var(--bg-primary);">
                    <p class="text-sm text-gray-400 mb-3">Remember, the above time is based on averages. You could find the shiny much sooner, or much later. Here are some Milestones to see how Lucky you are!</p>
                    <ul class="text-sm">
                        ${listHTML}
                    </ul>
                </div>
            `;
        }

        function displayResult(title, avgResets, totalSeconds, subtitle = '') {
            // Day/Night loss only applies to the main calculator
            const includeDayNight = document.getElementById('dayNightCycle').value === 'yes';
            let finalSeconds = totalSeconds;
            let timeLossText = '';

            // Check if the dayNightCycle element is visible/relevant
            if (simpleAdvancedCalculator.contains(dayNightCycle) && includeDayNight && !dayNightCycle.disabled) {
                 const loss = applyDayNightLoss(totalSeconds);
                 finalSeconds = totalSeconds + loss;
                 const lossTime = formatTime(loss);
                 timeLossText = ` (+${lossTime.hours}h ${lossTime.minutes}m ${lossTime.seconds}s from cinematics)`;
            }
            
            const time = formatTime(finalSeconds);
            const resets = Math.round(avgResets).toLocaleString();
            
            calculatedAverages[title] = finalSeconds;
            
            const uniqueId = title.replace(/\s+/g, '-') + '-' + Math.floor(avgResets);
            const milestoneHTML = buildMilestoneHTML(finalSeconds, uniqueId);

            const card = `
                <div class="result-card p-4">
                    <div class="flex justify-between items-center mb-1">
                        <span class="result-title">${title}</span>
                        <span class="text-sm font-medium text-gray-400">${resets} resets</span>
                    </div>
                    <p class="result-subtitle mb-2">${subtitle}</p>
                    <div class="result-time">
                        ${time.hours}h ${time.minutes}m ${time.seconds}s
                        <span class="text-sm text-gray-400 font-normal">${timeLossText}</span>
                    </div>
                    ${milestoneHTML}
                </div>
            `;
            resultsContainer.innerHTML += card;
        }

        function applyDayNightLoss(seconds) {
            const cycles = seconds / (24 * 60);
            const timeLoss = cycles * 12;
            return timeLoss;
        }

        function clearResults() {
            resultsContainer.innerHTML = '';
            errorArea.innerHTML = '';
            resultsArea.classList.add('hidden');
            afkSuggestionBox.classList.add('hidden');
            afkSuggestionText.innerHTML = '';
            
            reverseProbabilityBox.classList.add('hidden');
            probTimeResults.innerHTML = '';
            probTimeError.textContent = '';
            probTimeHours.value = '';
            probTimeMinutes.value = '';
        }

        function resetAdvancedFields() {
            // Specific Hunt
            document.getElementById('specificSpawns').value = '';
            document.getElementById('spawnPercentMethod').value = '';
            document.getElementById('spawnPercent').value = '';
            document.getElementById('dayNightLock').checked = false;
            
            document.getElementById('specificGender').checked = false;
            document.getElementById('genderRate').value = '50';
            
            document.getElementById('includeRespawnTime').checked = false;
            document.getElementById('spawnerRespawnTime').value = '';
            
            spawnPercentMethod.dispatchEvent(new Event('change'));
            includeRespawnTime.dispatchEvent(new Event('change')); 
            specificGender.dispatchEvent(new Event('change')); 
            
            updateRespawnTimeStatus();

            oddballSpawns.value = '';
            oddballExplainerBox.classList.add('toggle-hidden');

            // Alpha Hunt
            document.getElementById('includeAlphas').value = 'no';
            document.getElementById('includeGuaranteedAlphas').checked = false;
            document.getElementById('guaranteedAlphaCount').value = '';
            document.getElementById('includeNonGuaranteedAlphas').checked = false;
            
            document.getElementById('totalAlphaPotential').value = '';
            document.getElementById('nonStaticSpawns_0').value = '';
            document.getElementById('nonStaticSpawns_5').value = '';
            document.getElementById('nonStaticSpawns_20').value = '';
            
            document.getElementById('specificShinyAlpha').checked = false;
            document.getElementById('specificAlphaChance').value = '0.05';
            includeAlphas.dispatchEvent(new Event('change'));
            specificShinyAlpha.dispatchEvent(new Event('change'));
            
            // Time Loss
            dayNightCycle.value = 'no';
            dayNightCycle.disabled = false;
            dayNightHelper.classList.add('toggle-hidden');
            
            resetMethod.dispatchEvent(new Event('change'));
        }
        
        // --- Alpha Hunt UI Logic ---
        
        includeAlphas.addEventListener('change', () => {
            if (includeAlphas.value === 'yes') {
                alphaHuntOptionsContainer.classList.remove('toggle-hidden');
                includeGuaranteedAlphas.dispatchEvent(new Event('change'));
                includeNonGuaranteedAlphas.dispatchEvent(new Event('change'));
                updateAlphaPotential();
            } else {
                alphaHuntOptionsContainer.classList.add('toggle-hidden');
            }
        });

        includeGuaranteedAlphas.addEventListener('change', () => {
            if (includeGuaranteedAlphas.checked) {
                guaranteedAlphaContainer.classList.remove('toggle-hidden');
            } else {
                guaranteedAlphaContainer.classList.add('toggle-hidden');
            }
            updateAlphaPotential();
        });

        includeNonGuaranteedAlphas.addEventListener('change', () => {
            if (includeNonGuaranteedAlphas.checked) {
                nonGuaranteedAlphaContainer.classList.remove('toggle-hidden');
            } else {
                nonGuaranteedAlphaContainer.classList.add('toggle-hidden');
            }
        });
        
        function updateAlphaPotential() {
            const total = parseFloat(totalSpawnsInput.value) || 0;
            const staticCount = includeGuaranteedAlphas.checked ? (parseFloat(guaranteedAlphaCount.value) || 0) : 0;
            const eligible = Math.max(0, total - staticCount);
            totalAlphaPotential.value = eligible;
            validateNonStaticSpawns();
        }

        function validateNonStaticSpawns() {
            const potential = parseFloat(totalAlphaPotential.value) || 0;
            const s0 = parseFloat(nonStaticSpawns_0.value) || 0;
            const s5 = parseFloat(nonStaticSpawns_5.value) || 0;
            const s20 = parseFloat(nonStaticSpawns_20.value) || 0;
            const total = s0 + s5 + s20;

            if (total > potential) {
                nonGuaranteedAlphaError.classList.remove('toggle-hidden');
                return false;
            } else {
                nonGuaranteedAlphaError.classList.add('toggle-hidden');
                return true;
            }
        }

        totalSpawnsInput.addEventListener('keyup', updateAlphaPotential);
        totalSpawnsInput.addEventListener('change', updateAlphaPotential);
        guaranteedAlphaCount.addEventListener('keyup', updateAlphaPotential);
        guaranteedAlphaCount.addEventListener('change', updateAlphaPotential);
        nonGuaranteedInputs.forEach(input => {
            input.addEventListener('keyup', validateNonStaticSpawns);
            input.addEventListener('change', validateNonStaticSpawns);
        });
        
        specificShinyAlpha.addEventListener('change', () => {
            if (specificShinyAlpha.checked) {
                specificAlphaChanceContainer.classList.remove('toggle-hidden');
            } else {
                specificAlphaChanceContainer.classList.add('toggle-hidden');
            }
        });
        
        // --- END Alpha Hunt UI Logic ---
        
        probTimeBtn.addEventListener('click', () => {
            const hours = parseInt(probTimeHours.value) || 0;
            const minutes = parseInt(probTimeMinutes.value) || 0;

            probTimeError.textContent = '';
            probTimeResults.innerHTML = '';

            if (hours < 0 || hours > 23) {
                probTimeError.textContent = 'Invalid hours. Max is 23.';
                return;
            }
            if (minutes < 0 || minutes > 59) {
                probTimeError.textContent = 'Invalid minutes. Max is 59.';
                return;
            }

            const totalInputSeconds = (hours * 3600) + (minutes * 60);
            if (totalInputSeconds <= 0) {
                return; 
            }

            let resultsHTML = '<ul class="text-sm">';
            for (const title in calculatedAverages) {
                const avgSeconds = calculatedAverages[title];
                if (avgSeconds > 0) {
                    const probability = 1 - Math.exp(-totalInputSeconds / avgSeconds);
                    let probabilityPercent = (probability * 100);
                    
                    if (probabilityPercent > 99.99) {
                        probabilityPercent = 99.99;
                    }
                    
                    resultsHTML += `
                        <li class="milestone-list-item">
                            <span class="milestone-label">${title}</span>
                            <span class="milestone-time">${probabilityPercent.toFixed(2)}%</span>
                        </li>
                    `;
                }
            }
            resultsHTML += '</ul>';
            probTimeResults.innerHTML = resultsHTML;
        });
        
    </script>
</body>
</html>